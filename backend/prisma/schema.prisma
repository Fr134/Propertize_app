generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Enums
// ============================================

enum UserRole {
  MANAGER
  OPERATOR
}

enum PropertyType {
  APPARTAMENTO
  VILLA
  ALTRO
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  APPROVED
  REJECTED
  DONE
}

enum TaskType {
  CLEANING
  PREPARATION
  MAINTENANCE
  INSPECTION
  KEY_HANDOVER
  OTHER
}

enum AssigneeType {
  INTERNAL
  EXTERNAL
}

enum ExternalContactCategory {
  PLUMBER
  ELECTRICIAN
  CLEANER
  HANDYMAN
  INSPECTOR
  OTHER
}

enum LinenType {
  LENZUOLA
  ASCIUGAMANI
  TOVAGLIE
}

enum LinenStatus {
  SPORCA
  IN_LAVAGGIO
  PRONTA
}

enum ReportCategory {
  DANNO
  MANUTENZIONE
  OGGETTO_MANCANTE
}

enum ReportPriority {
  BASSA
  MEDIA
  ALTA
}

enum ReportStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
}

enum ItemCondition {
  GOOD
  DAMAGED
  BROKEN
  REPLACED
}

enum ExpenseCategory {
  MAINTENANCE
  CLEANING
  UTILITIES
  SUPPLIES
  INSURANCE
  TAX
  OTHER
}

enum TransactionType {
  PURCHASE_IN
  CONSUMPTION_OUT
  ADJUSTMENT
}

enum PurchaseOrderStatus {
  DRAFT
  ORDERED
  RECEIVED
  CANCELLED
}

enum LeadStatus {
  NEW
  CONTACTED
  INTERESTED
  PROPOSAL_SENT
  NEGOTIATING
  WON
  LOST
}

enum LeadSource {
  MANUAL
  REFERRAL
  SOCIAL
  WEBSITE
  OTHER
}

// ============================================
// Models
// ============================================

model User {
  id            String   @id @default(uuid()) @db.Uuid
  email         String   @unique
  password_hash String
  first_name    String
  last_name     String
  role          UserRole
  phone         String?
  avatar_url    String?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  assigned_tasks   Task[]              @relation("AssignedTasks")
  reviewed_tasks   Task[]              @relation("ReviewedTasks")
  reopened_tasks   Task[]              @relation("ReopenedTasks")
  reports_created  MaintenanceReport[]
  expenses_created Expense[]

  @@map("users")
}

model Owner {
  id                 String    @id @default(uuid()) @db.Uuid
  name               String
  email              String?
  phone              String?
  address            String?
  fiscal_code        String?
  iban               String?
  notes              String?
  status             String    @default("active")
  contract_signed_at DateTime?
  created_at         DateTime  @default(now())

  properties Property[]
  lead       Lead?

  @@map("owners")
}

model Property {
  id                 String       @id @default(uuid()) @db.Uuid
  name               String
  code               String       @unique
  address            String
  property_type      PropertyType
  owner_id           String?      @db.Uuid
  bedroom_count      Int?
  bathroom_count     Int?
  max_guests         Int?
  floor_area_sqm     Decimal?     @db.Decimal(8, 2)
  floor_number       Int?
  has_elevator       Boolean?
  has_parking        Boolean?
  has_pool           Boolean?
  wifi_network       String?
  wifi_password      String?
  door_code          String?
  alarm_code         String?
  gas_meter_location String?
  water_shutoff      String?
  electricity_panel  String?
  trash_schedule     String?
  checkin_notes      String?
  checkout_notes     String?
  internal_notes     String?
  contract_url           String?
  active                 Boolean      @default(true)
  // ID dell'immobile su DotHouse (null = solo manuale)
  // Se valorizzato, l'immobile è collegato a DotHouse ma si può
  // comunque creare task manuali su di esso
  dotthouse_property_id  String?      @unique
  created_at         DateTime     @default(now())
  updated_at         DateTime     @updatedAt

  owner              Owner?             @relation(fields: [owner_id], references: [id])
  checklist_template ChecklistTemplate?
  tasks              Task[]
  linen_inventory    LinenInventory[]
  reports            MaintenanceReport[]
  expenses           Expense[]
  master_file        PropertyMasterFile?
  inventory_items    PropertyInventoryItem[]
  supply_stocks      PropertySupplyStock[]
  bookings           DothouseBooking[]

  @@map("properties")
}

model ChecklistTemplate {
  id          String   @id @default(uuid()) @db.Uuid
  property_id String   @unique @db.Uuid
  items       Json
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  property Property @relation(fields: [property_id], references: [id], onDelete: Cascade)

  @@map("checklist_templates")
}

model PropertyMasterFile {
  id                String   @id @default(uuid()) @db.Uuid
  property_id       String   @unique @db.Uuid
  plumber_name      String?
  plumber_phone     String?
  electrician_name  String?
  electrician_phone String?
  cleaner_notes     String?
  cadastral_id      String?
  cie_code          String?
  tourism_license   String?
  custom_fields     Json?
  cover_photo_url   String?
  floorplan_url     String?
  additional_photos Json?
  drive_folder_url  String?
  updated_at        DateTime @updatedAt

  property Property @relation(fields: [property_id], references: [id], onDelete: Cascade)

  @@map("property_master_files")
}

model PropertyInventoryItem {
  id               String         @id @default(uuid()) @db.Uuid
  property_id      String         @db.Uuid
  room             String
  name             String
  brand            String?
  model            String?
  serial_number    String?
  purchase_date    DateTime?
  warranty_expires DateTime?
  notes            String?
  photo_url        String?
  condition        ItemCondition  @default(GOOD)
  created_at       DateTime       @default(now())
  updated_at       DateTime       @updatedAt

  property Property @relation(fields: [property_id], references: [id], onDelete: Cascade)

  @@index([property_id, room])
  @@map("property_inventory_items")
}

model PropertySupplyStock {
  id              String   @id @default(uuid()) @db.Uuid
  property_id     String   @db.Uuid
  supply_item_id  String   @db.Uuid
  qty_current     Int      @default(0)
  qty_standard    Int      @default(1)
  low_threshold   Int      @default(0)
  updated_at      DateTime @updatedAt
  updated_by_task String?  @db.Uuid

  property    Property   @relation(fields: [property_id], references: [id], onDelete: Cascade)
  supply_item SupplyItem @relation(fields: [supply_item_id], references: [id])

  @@unique([property_id, supply_item_id])
  @@map("property_supply_stocks")
}

model Task {
  id                    String        @id @default(uuid()) @db.Uuid
  property_id           String        @db.Uuid
  assigned_to           String?       @db.Uuid
  scheduled_date        DateTime      @db.Date
  status                TaskStatus    @default(TODO)
  checklist_data        Json?
  notes                 String?
  completed_at          DateTime?
  reviewed_at           DateTime?
  reviewed_by           String?       @db.Uuid
  rejection_notes       String?
  reopen_note           String?
  reopen_at             DateTime?
  reopen_by             String?       @db.Uuid
  task_type             TaskType      @default(CLEANING)
  title                 String?
  start_time            DateTime?
  end_time              DateTime?
  assignee_type         AssigneeType  @default(INTERNAL)
  external_assignee_id  String?       @db.Uuid
  can_use_supplies      Boolean       @default(false)
  is_scheduled          Boolean       @default(true)
  // Se dotthouse_booking_id IS NULL → task creato manualmente
  // Se dotthouse_booking_id IS NOT NULL → task generato da prenotazione DotHouse
  dotthouse_booking_id  String?       @unique @db.Uuid
  created_at            DateTime      @default(now())
  updated_at            DateTime      @updatedAt

  property           Property          @relation(fields: [property_id], references: [id])
  operator           User?             @relation("AssignedTasks", fields: [assigned_to], references: [id])
  reviewer           User?             @relation("ReviewedTasks", fields: [reviewed_by], references: [id])
  reopener           User?             @relation("ReopenedTasks", fields: [reopen_by], references: [id])
  external_assignee  ExternalContact?  @relation(fields: [external_assignee_id], references: [id])
  dotthouse_booking  DothouseBooking?  @relation(fields: [dotthouse_booking_id], references: [id])
  photos             TaskPhoto[]
  reports            MaintenanceReport[]
  supply_usages      TaskSupplyUsage[]

  @@map("tasks")
}

model ExternalContact {
  id         String                  @id @default(uuid()) @db.Uuid
  name       String
  phone      String?
  email      String?
  company    String?
  category   ExternalContactCategory
  notes      String?
  is_active  Boolean                 @default(true)
  created_at DateTime                @default(now())
  updated_at DateTime                @updatedAt

  assigned_tasks Task[]

  @@map("external_contacts")
}

model DothouseBooking {
  id             String    @id @default(uuid()) @db.Uuid
  property_id    String    @db.Uuid
  external_id    String    @unique
  guest_name     String?
  checkin_date   DateTime  @db.Date
  checkout_date  DateTime  @db.Date
  guests_count   Int?
  platform       String?
  status         String    @default("confirmed")
  sync_status      String    @default("pending")
  // pending = arrivata da DotHouse, manager deve schedulare la pulizia
  // scheduled = manager ha assegnato data e operatrice
  // skipped = manager ha deciso di non creare un task per questa prenotazione
  scheduling_mode  String    @default("pending")
  raw_data         Json?
  synced_at      DateTime?
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt

  property       Property  @relation(fields: [property_id], references: [id])
  cleaning_task  Task?

  @@index([property_id, checkin_date])
  @@map("dotthouse_bookings")
}

model TaskPhoto {
  id                   String   @id @default(uuid()) @db.Uuid
  task_id              String   @db.Uuid
  checklist_item_index Int
  photo_url            String
  uploaded_at          DateTime @default(now())

  task Task @relation(fields: [task_id], references: [id], onDelete: Cascade)

  @@map("task_photos")
}

model LinenInventory {
  id          String      @id @default(uuid()) @db.Uuid
  property_id String      @db.Uuid
  type        LinenType
  status      LinenStatus
  quantity    Int
  updated_at  DateTime    @default(now()) @updatedAt

  property Property @relation(fields: [property_id], references: [id], onDelete: Cascade)

  @@unique([property_id, type, status])
  @@map("linen_inventory")
}

model MaintenanceReport {
  id          String         @id @default(uuid()) @db.Uuid
  property_id String         @db.Uuid
  task_id     String?        @db.Uuid
  created_by  String         @db.Uuid
  title       String
  description String
  category    ReportCategory
  priority    ReportPriority
  status      ReportStatus   @default(OPEN)
  created_at  DateTime       @default(now())
  updated_at  DateTime       @updatedAt
  resolved_at DateTime?

  property Property      @relation(fields: [property_id], references: [id])
  task     Task?          @relation(fields: [task_id], references: [id])
  author   User           @relation(fields: [created_by], references: [id])
  photos   ReportPhoto[]

  @@map("maintenance_reports")
}

model ReportPhoto {
  id          String   @id @default(uuid()) @db.Uuid
  report_id   String   @db.Uuid
  photo_url   String
  uploaded_at DateTime @default(now())

  report MaintenanceReport @relation(fields: [report_id], references: [id], onDelete: Cascade)

  @@map("report_photos")
}

model Expense {
  id           String           @id @default(uuid()) @db.Uuid
  property_id  String           @db.Uuid
  created_by   String           @db.Uuid
  description  String
  amount       Decimal          @db.Decimal(10, 2)
  vat_amount   Decimal?         @db.Decimal(10, 2)
  expense_date DateTime         @db.Date @default(now())
  is_billed    Boolean          @default(false)
  billed_at    DateTime?
  is_paid      Boolean          @default(false)
  paid_at      DateTime?
  category     ExpenseCategory?
  created_at   DateTime         @default(now())
  updated_at   DateTime         @updatedAt

  property Property       @relation(fields: [property_id], references: [id])
  author   User           @relation(fields: [created_by], references: [id])
  photos   ExpensePhoto[]

  @@map("expenses")
}

model ExpensePhoto {
  id          String   @id @default(uuid()) @db.Uuid
  expense_id  String   @db.Uuid
  photo_url   String
  uploaded_at DateTime @default(now())

  expense Expense @relation(fields: [expense_id], references: [id], onDelete: Cascade)

  @@map("expense_photos")
}

// ============================================
// Inventory System
// ============================================

model SupplyItem {
  id         String   @id @default(uuid()) @db.Uuid
  name       String
  sku        String?  @unique
  unit       String   @default("pz")
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  balance       InventoryBalance?
  transactions  InventoryTransaction[]
  task_usages   TaskSupplyUsage[]
  order_lines   PurchaseOrderLine[]
  supply_stocks PropertySupplyStock[]

  @@map("supply_items")
}

model InventoryBalance {
  id             String   @id @default(uuid()) @db.Uuid
  supply_item_id String   @unique @db.Uuid
  qty_on_hand    Int      @default(0)
  reorder_point  Int      @default(0)
  updated_at     DateTime @updatedAt

  supply_item SupplyItem @relation(fields: [supply_item_id], references: [id], onDelete: Cascade)

  @@map("inventory_balances")
}

model InventoryTransaction {
  id             String          @id @default(uuid()) @db.Uuid
  supply_item_id String          @db.Uuid
  type           TransactionType
  qty            Int
  reference_id   String?         @db.Uuid
  notes          String?
  created_by     String?         @db.Uuid
  created_at     DateTime        @default(now())

  supply_item SupplyItem @relation(fields: [supply_item_id], references: [id])

  @@index([supply_item_id, created_at])
  @@map("inventory_transactions")
}

model TaskSupplyUsage {
  id             String   @id @default(uuid()) @db.Uuid
  task_id        String   @db.Uuid
  supply_item_id String   @db.Uuid
  expected_qty   Int      @default(1)
  qty_used       Int      @default(0)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  task        Task       @relation(fields: [task_id], references: [id], onDelete: Cascade)
  supply_item SupplyItem @relation(fields: [supply_item_id], references: [id])

  @@unique([task_id, supply_item_id])
  @@map("task_supply_usages")
}

model PurchaseOrder {
  id          String              @id @default(uuid()) @db.Uuid
  order_ref   String?
  status      PurchaseOrderStatus @default(DRAFT)
  notes       String?
  ordered_at  DateTime?
  received_at DateTime?
  created_by  String              @db.Uuid
  created_at  DateTime            @default(now())
  updated_at  DateTime            @updatedAt

  lines PurchaseOrderLine[]

  @@map("purchase_orders")
}

model PurchaseOrderLine {
  id                String   @id @default(uuid()) @db.Uuid
  purchase_order_id String   @db.Uuid
  supply_item_id    String   @db.Uuid
  qty_ordered       Int
  qty_received      Int      @default(0)
  unit_cost         Decimal? @db.Decimal(10, 2)

  purchase_order PurchaseOrder @relation(fields: [purchase_order_id], references: [id], onDelete: Cascade)
  supply_item    SupplyItem    @relation(fields: [supply_item_id], references: [id])

  @@unique([purchase_order_id, supply_item_id])
  @@map("purchase_order_lines")
}

// ============================================
// CRM
// ============================================

model Lead {
  id               String        @id @default(uuid()) @db.Uuid
  first_name       String
  last_name        String
  email            String?
  phone            String?
  notes            String?
  status           LeadStatus    @default(NEW)
  source           LeadSource    @default(MANUAL)
  property_address String?
  property_type    PropertyType?
  estimated_rooms  Int?
  created_at       DateTime      @default(now())
  updated_at       DateTime      @updatedAt
  converted_at     DateTime?
  owner_id         String?       @unique @db.Uuid

  owner Owner? @relation(fields: [owner_id], references: [id])
  calls Call[]

  @@map("leads")
}

model Call {
  id         String   @id @default(uuid()) @db.Uuid
  lead_id    String   @db.Uuid
  notes      String
  called_at  DateTime @default(now())
  created_by String   @db.Uuid

  lead Lead @relation(fields: [lead_id], references: [id], onDelete: Cascade)

  @@map("calls")
}
